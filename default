server {
	client_max_body_size 600m;
	client_header_buffer_size 1k;
	client_body_buffer_size 256k;
	large_client_header_buffers 4 16k;

	listen 80 default_server;
	listen [::]:80 default_server ipv6only=on;

	root /var/www/html/public;

	index index.php index.html index.htm;

	server_name _;

	charset utf-8;

	error_page 404 /index.php;

    #- Blitz cache rewrite
    set $cache_path false;

    if ($request_method = GET) {
        set $cache_path /cache/blitz/$host/$uri/$args/index.html;
    }

    if ($args ~ "token=") {
        set $cache_path false;
    }

    #- Send would-be 404 requests to the cache path or Craft
	location / {
        # First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $cache_path $uri $uri/ /index.php?$query_string;

        # Uncomment to enable naxsi on this location
		# include /etc/nginx/naxsi.rules
	}

	location ^~ /admin {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ^~ /cpresources {
        try_files $uri $uri/ /index.php?$query_string;
    }

	location ^~ /.well-known/acme-challenge/ {
        allow all;
        default_type "text/plain";
        
        root /var/www/html/public;
	}

	location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        
        fastcgi_connect_timeout 600;
        fastcgi_send_timeout 600;
        fastcgi_read_timeout 600;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        
        fastcgi_pass unix:/run/php/php7.4-fpm.sock;
        
        # Point to our PHP FPM docker container.
        #fastcgi_pass phpfpm:9000;
	}

	location ~* (?:^|/)\. {
        access_log off;
        log_not_found off;
        deny all;
	}

	location = /favicon.ico {
        etag off;
        access_log off;
        log_not_found off;
	}

	location = /robots.txt {
        etag off;
        access_log off;
        log_not_found off;
	}
	
	location ~* (.+)\.(?:\d+)\.(js|css|png|jpg|svg|jpeg|gif|webp)$ {
        etag off;
        expires 1M;
        access_log off;
        add_header Cache-Control "public";
        try_files $uri $1.$2;
    }

	location ~* (?:\.(?:bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~)$ {
        etag off;
        access_log off;
        log_not_found off;
        deny all;
	}

	location ~* \.(?:manifest|appcache|html?|xml|json)$ {
        etag off;
        access_log off;
        log_not_found off;
        expires -1;
	}

	location ~* \.(?:rss|atom)$ {
        etag off;
        access_log off;
        log_not_found off;
        expires 1h;
        try_files $uri $uri/ /index.php?$query_string;
        # max-age=2592000 = 1 month in seconds, stale-while-revalidate=86400 = 1 day in seconds
        add_header Cache-Control "public, max-age=2592000, must-revalidate, stale-while-revalidate=86400";
	}

	location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp3|mp4|ogg|ogv|webm|htc|webp)$ {
        etag off;
        access_log off;
        log_not_found off;
        expires 1M;
        try_files $uri $uri/ /index.php?$query_string;
        # max-age=2592000 = 1 month in seconds, stale-while-revalidate=86400 = 1 day in seconds
        add_header Cache-Control "public, max-age=2592000, must-revalidate, stale-while-revalidate=86400";
	}

	location ~* \.(?:css|js)$ {
        etag off;
        access_log off;
        log_not_found off;
        expires 1y;
        try_files $uri $uri/ /index.php?$query_string;
        # max-age=31556952 = 1 year in seconds
        add_header Cache-Control "public, max-age=31556952, immutable";
	}

	location ~* \.(?:ttf|ttc|otf|eot|woff|woff2)$ {
        etag off;
        add_header "Access-Control-Allow-Origin" "*";
        access_log off;
        log_not_found off;
        expires 1M;
        try_files $uri $uri/ /index.php?$query_string;
        # max-age=2592000 = 1 month in seconds, stale-while-revalidate=86400 = 1 day in seconds
        add_header Cache-Control "public, max-age=2592000, must-revalidate, stale-while-revalidate=86400";
	}

	# deny access to .htaccess files, if Apache's document root concurs with nginx's one
	location ~ /\.ht {
        etag off;
        access_log off;
        log_not_found off;
        deny all;
	}
}
